name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release, e.g.: 2.8.16-1"
        required: true
        type: string
      package_release:
        description: "Package release identifier (used for the distro release field)"
        required: false
        default: ""
        type: string

concurrency:
  group: release-${{ github.event.inputs.version }}-${{ github.event.inputs.package_release }}
  cancel-in-progress: false

jobs:
  validate-version:
    name: Validate semantic version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          sparse-checkout: .github/actions/validate-semver
      - name: Validate semantic version
        uses: ./.github/actions/validate-semver
        with:
          version: ${{ github.event.inputs.version }}

  tests:
    uses: ./.github/workflows/tests.yml

  release:
    name: Release
    needs: [validate-version, tests]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HAPROXY_BUILD_TARGETS: "el9=rockylinux:9 el8=rockylinux:8"
    steps:
      - name: Check out repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Load upstream version
        run: |
          set -euo pipefail
          source versions.env
          echo "HAPROXY_VERSION=${HAPROXY_VERSION}" >> "$GITHUB_ENV"
      - name: Determine package release
        run: |
          set -euo pipefail
          pkg_release="${INPUT_PACKAGE_RELEASE}"
          if [ -z "$pkg_release" ]; then
            if [[ "${INPUT_VERSION}" =~ -([0-9A-Za-z._]+)$ ]]; then
              pkg_release="${BASH_REMATCH[1]}"
            else
              pkg_release="1"
            fi
          fi
          echo "PACKAGE_RELEASE=${pkg_release}" >> "$GITHUB_ENV"
          printf 'Using PACKAGE_RELEASE=%s\n' "${pkg_release}"
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_PACKAGE_RELEASE: ${{ github.event.inputs.package_release }}
      - name: Set git identity
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
      - name: Create local tag
        run: |
          V="${{ github.event.inputs.version }}"
          if git rev-parse -q --verify "refs/tags/$V" >/dev/null; then
            git tag -d "$V"
          fi
          git tag -a "$V" -m "$V"
      - name: Render GoReleaser config
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          content = Path(".goreleaser.yml").read_text()
          needle = "release: '{{ .Env.PACKAGE_RELEASE }}'"
          replacement = f"release: '{os.environ['PACKAGE_RELEASE']}'"
          if needle not in content:
              raise SystemExit(f"Could not find template token '{needle}' in .goreleaser.yml")
          Path(".goreleaser.rendered.yml").write_text(content.replace(needle, replacement))
          PY
      - name: Build artifacts only
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: "~> v2"
          args: release --skip=publish --clean --config .goreleaser.rendered.yml
      - name: Push tag
        run: |
          V="${{ github.event.inputs.version }}"
          if git ls-remote --tags origin | grep -qx ".*refs/tags/$V"; then
            echo "Tag $V already exists on origin. Aborting." >&2
            exit 1
          fi
          git push origin "$V"
      - name: Publish release
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: "~> v2"
          args: release --clean --config .goreleaser.rendered.yml
